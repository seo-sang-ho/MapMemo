<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Map Memo</title>
    <script th:src="@{|//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoApikey}|}"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; }
        h2 { padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; }
        #map { width: 100%; height: 90vh; }
    </style>
</head>
<body>
<h2>ğŸ—ºï¸ ì§€ë„ì— ë©”ëª¨ ë‚¨ê¸°ê¸°</h2>

<!-- ì‚¬ì´ë“œë°” -->
<div id="sidebar" th:replace="sidebar :: sidebarFragment"></div>

<!-- ì§€ë„ -->
<div id="map"></div>

<script th:inline="javascript">
    kakao.maps.load(function() {
        const container = document.getElementById('map');
        const options = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // ê¸°ë³¸ê°’ (ì„œìš¸)
            level: 3
        };
        const map = new kakao.maps.Map(container, options);

        // âœ… í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™ (Geolocation)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const currentPosition = new kakao.maps.LatLng(lat, lng);

                    // ì§€ë„ ì¤‘ì‹¬ì„ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
                    map.setCenter(currentPosition);

        // âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ (ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ì‚¬ìš©)
        const imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; // ì˜ˆì‹œ ì´ë¯¸ì§€
        const imageSize = new kakao.maps.Size(24, 35); // ì´ë¯¸ì§€ í¬ê¸°
        const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                    // í˜„ì¬ ìœ„ì¹˜ì— ë§ˆì»¤ í‘œì‹œ
                    new kakao.maps.Marker({
                        map: map,
                        position: currentPosition,
                        title: "í˜„ì¬ ìœ„ì¹˜",
                        image: markerImage
                    });
                },
                function(error) {
                    console.warn("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", error);
                }
            );
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        // âœ… ê¸°ì¡´ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
        fetch('/api/memos')
            .then(res => res.ok ? res.json() : Promise.reject("ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"))
            .then(data => data.forEach(memo => addMarker(memo)))
            .catch(err => console.error(err));

// ì§€ë„ í´ë¦­ ì‹œ ë©”ëª¨ ë“±ë¡
kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
    const latlng = mouseEvent.latLng;

    const title = prompt("ë©”ëª¨ ì œëª©:");
    const content = prompt("ë©”ëª¨ ë‚´ìš©:");

    // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì•ˆë‚´
    const category = prompt("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”:\n1: í™”ì¥ì‹¤(TOILET)\n2: ê°€ê²Œ(STORE)\n3: ê¸°íƒ€(ETC)");

    let categoryValue;
    switch(category) {
        case "1":
            categoryValue = "TOILET";
            break;
        case "2":
            categoryValue = "STORE";
            break;
        case "3":
            categoryValue = "ETC";
            break;
        default:
            alert("ì˜¬ë°”ë¥¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
    }

    if (!title || !content) return;

    const memoData = {
        title,
        content,
        category: categoryValue,
        latitude: latlng.getLat(),
        longitude: latlng.getLng()
    };

    fetch('/api/memos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(memoData)
    })
    .then(res => res.ok ? res.json() : Promise.reject("ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨"))
    .then(savedMemo => {
        alert(`[${savedMemo.category}] ${savedMemo.title} ì €ì¥ ì™„ë£Œ!`);
        addMarker(savedMemo); // ì§€ë„ + ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
    })
    .catch(err => alert(err));
});



        // âœ… ë§ˆì»¤ + í’ì„ ì°½ í•¨ìˆ˜
        function addMarker(memo) {
    const marker = new kakao.maps.Marker({
        map,
        position: new kakao.maps.LatLng(memo.latitude, memo.longitude),
        title: memo.title
    });

    const info = new kakao.maps.InfoWindow({
        content: `
            <div style="padding:6px; min-width:150px;">
                <strong>${memo.title}</strong> (${memo.category})<br>
                <small>${memo.content}</small>
            </div>`
    });

    kakao.maps.event.addListener(marker, 'click', () => info.open(map, marker));

    // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
    const ul = document.getElementById("memo-list");
    const li = document.createElement("li");
    li.textContent = `${memo.title} (${memo.category})`;
    ul.appendChild(li);
}

    });
</script>
</body>
</html>
