<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Map Memo</title>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=b8e3c3388eb97f7ae6447be9cb10a75f&autoload=false"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; }
        h2 { padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; }
        #map { width: 100%; height: 90vh; }
    </style>
</head>
<body>
<h2>ğŸ—ºï¸ ì§€ë„ì— ë©”ëª¨ ë‚¨ê¸°ê¸°</h2>
<div id="map"></div>

<script th:inline="javascript">
    kakao.maps.load(function() {
        const container = document.getElementById('map');
        const options = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // ê¸°ë³¸ê°’ (ì„œìš¸)
            level: 3
        };
        const map = new kakao.maps.Map(container, options);

        // âœ… í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™ (Geolocation)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const currentPosition = new kakao.maps.LatLng(lat, lng);

                    // ì§€ë„ ì¤‘ì‹¬ì„ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
                    map.setCenter(currentPosition);

        // âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ (ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ì‚¬ìš©)
        const imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; // ì˜ˆì‹œ ì´ë¯¸ì§€
        const imageSize = new kakao.maps.Size(24, 35); // ì´ë¯¸ì§€ í¬ê¸°
        const markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

                    // í˜„ì¬ ìœ„ì¹˜ì— ë§ˆì»¤ í‘œì‹œ
                    new kakao.maps.Marker({
                        map: map,
                        position: currentPosition,
                        title: "í˜„ì¬ ìœ„ì¹˜",
                        image: markerImage
                    });
                },
                function(error) {
                    console.warn("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", error);
                }
            );
        } else {
            alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        // âœ… ê¸°ì¡´ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
        fetch('/api/memos')
            .then(res => res.ok ? res.json() : Promise.reject("ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"))
            .then(data => data.forEach(memo => addMarker(memo)))
            .catch(err => console.error(err));

        // âœ… ì§€ë„ í´ë¦­ ì‹œ ë©”ëª¨ ë“±ë¡
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            const latlng = mouseEvent.latLng;
            const title = prompt("ë©”ëª¨ ì œëª©:");
            const content = prompt("ë©”ëª¨ ë‚´ìš©:");

            if (!title || !content) return;

            const memoData = {
                title,
                content,
                latitude: latlng.getLat(),
                longitude: latlng.getLng()
            };

            fetch('/api/memos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(memoData)
            })
            .then(res => res.ok ? res.json() : Promise.reject("ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨"))
            .then(savedMemo => {
                alert("ë©”ëª¨ ì €ì¥ ì™„ë£Œ!");
                addMarker(savedMemo);
            })
            .catch(err => alert(err));
        });

        // âœ… ë§ˆì»¤ + í’ì„ ì°½ í•¨ìˆ˜
        function addMarker(memo) {
            const marker = new kakao.maps.Marker({
                map,
                position: new kakao.maps.LatLng(memo.latitude, memo.longitude),
                title: memo.title
            });

            const info = new kakao.maps.InfoWindow({
                content: `
                    <div style="padding:6px; min-width:150px;">
                        <strong>${memo.title}</strong><br>
                        <small>${memo.content}</small>
                    </div>`
            });

            kakao.maps.event.addListener(marker, 'click', () => info.open(map, marker));
        }
    });
</script>
</body>
</html>
